<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor Drawing Game</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
    </style>
    <script src="game.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js" integrity="sha512-tE1z+95+lMCGwy+9PnKgUSIeHhvioC9lMlI7rLWU0Ps3XTdjRygLcy4mLuL0JAoK4TLdQEyP0yOl/9dMOqpH/Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <div id="initialScreen" class="gameScreen">

        <input type="text" id="playerName" placeholder="Enter player name">
        <button onclick="addPlayer()">Add Player</button>
        <button onclick="startGame()">Start Game</button>
        <div id="playerList">
            <!-- Lista de jogadores será exibida aqui -->
        </div>
    </div>

    <div id="gameScreen" style="display: none;">
        <body-wrapper>
            <div id="canvasArea"></div>
            <div id="shapeDeck" style="display: none;">
                <div id="slot1" class="shapeSlot empty"></div>
                <div id="slot2" class="shapeSlot empty"></div>
                <div id="slot3" class="shapeSlot empty"></div>
                <div id="slot4" class="shapeSlot empty"></div>
                <div id="slot5" class="shapeSlot empty"></div>
            </div>

            <div id="transitionScreen" class="gameScreen" style="display: none;">
                <p id="playerTurnMessage"></p>
                <button onclick="confirmTurn()">Confirm</button>
            </div>

            <div id="currentTurn" class="gameScreen" style="display: none;">
                <p id="currentPlayerName"></p>
                <p id="wordToDraw"></p>
            </div>

            <div id="eliminationScreen" class="gameScreen" style="display: none;">
                <p>Escolha um jogador para eliminar:</p>
                <select id="playerSelect">
                    <!-- Opções de jogador serão adicionadas aqui -->
                </select>
                <div style="display: flex; flex-direction: row; align-items: center; justify-content: center; width: 100%">
                    <button onclick="eliminatePlayer()">Eliminar</button>
                    <button onclick="skipElimination()">Pular</button>
                </div>
            </div>

            <div id="impostorEliminatedScreen" class="gameScreen" style="display: none;">
                <p>O impostor foi eliminado ou há menos de dois jogadores! <br> Partida encerrada.</p>
                <button onclick="showResults()">Mostrar Resultados</button>
            </div>

            <div id="resultsScreen" class="gameScreen" style="display: none;">
                <h2>Resultados</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Nome do Jogador</th>
                            <!-- <th>Cor</th> -->
                            <th>Palavra</th>
                            <th>Impostor?</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- Linhas da tabela serão adicionadas aqui -->
                    </tbody>
                </table>
            </div>

        </body-wrapper>
    </div>

    <script>
        const socket = io(window.location.href.replace("http", "ws"));

        socket.on('updatePlayerList', (players) => {
            console.log('Lista de jogadores atualizada:', players);
            updatePlayerList(players);
        });

        socket.on('gameStarted', () => {
            console.log('Jogo iniciado!');
            startGameUI();
        });

        socket.on('showPlayerTurn', (playerName) => {
            console.log('Vez do jogador:', playerName);
            showPlayerTurn(playerName);
        });

        socket.on('showEliminationScreen', (players) => {
            console.log('Mostrar tela de eliminação');
            showEliminationScreen(players);
        });

        socket.on('playerEliminated', () => {
            console.log('Jogador eliminado');
            playerEliminated();
        });

        socket.on('impostorEliminated', () => {
            console.log('Impostor eliminado');
            impostorEliminated();
        });

        socket.on('showResults', () => {
            console.log('Mostrar resultados');
            showResults();
        });

        socket.on('alert', (message) => {
            alert(message);
        });

        let players = [];
        let originalPlayers = [];
        let currentPlayerIndex = 0;
        let impostorIndex = -1;
        let impostorWord = "";

        function addPlayer() {
            const input = document.getElementById("playerName");
            const playerName = input.value.trim();
            if (playerName !== "") {
                // Gera uma cor única para o jogador
                const color = generateUniqueColor();
                players.push({ name: playerName, color: color, word: "", impostor: false, playerOptions: ['', '', '', '', ''] });
                input.value = "";
                socket.emit('addPlayer', playerName);
                //updatePlayerList();
            }
        }

        function updatePlayerList(gamers) {
            const playerListDiv = document.getElementById("playerList");
            playerListDiv.innerHTML = "";
            players = gamers
            gamers.forEach(player => {
                const playerNameSpan = document.createElement("span");
                playerNameSpan.textContent = player.name;
                playerNameSpan.style.color = player.color;
                playerListDiv.appendChild(playerNameSpan);
                playerListDiv.appendChild(document.createElement("br")); // Adiciona nova linha
            });
        }

        function generateUniqueColor() {
            // Gera uma cor aleatória hexadecimal
            return '#' + Math.floor(Math.random() * 16777215).toString(16);
        }

        function startGame() {
            socket.emit('startGame', players);
        }

        function startGameUI() {
            impostorIndex = Math.floor(Math.random() * players.length);
            players[impostorIndex].impostor = true;

            // Define a palavra para desenhar
            let words = ["Cachorro", "Gato"];

            players.map(player => {
                if (player.impostor) {
                    player.word = words[1]
                } else {
                    player.word = words[0]
                }
                return player
            });

            originalPlayers = [...players]

            // Oculta a tela inicial
            document.getElementById("initialScreen").style.display = "none";

            // Mostra a tela de transição
            document.getElementById("transitionScreen").style.display = "flex";
            document.getElementById("gameScreen").style.display = "flex";
            document.getElementById("playerTurnMessage").textContent = "É a vez do jogador " + players[currentPlayerIndex].name;

            initializeCanvas(players[currentPlayerIndex].color);
        }

        function showPlayerTurn(playerName) {
            // Oculta a tela de transição
            document.getElementById("transitionScreen").style.display = "none";

            // Mostra a tela do jogo
            document.getElementById("shapeDeck").style.display = "flex";
            document.getElementById("currentTurn").style.display = "flex";
            document.getElementById("gameScreen").style.display = "flex";

            // Exibe o nome do jogador atual
            document.getElementById("currentPlayerName").textContent = "Jogador: " + playerName;

            document.getElementById("wordToDraw").textContent = "Palavra para desenhar: " + players[currentPlayerIndex].word;
            initializeCanvas(players[currentPlayerIndex].color);
        }

        function confirmTurn() {
            socket.emit('confirmTurn');
        }

        function nextPlayer() {
            // Avança para o próximo jogador
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;

            if (currentPlayerIndex === 0) {
                // Todos os jogadores deram "Next", mostra a tela de eliminação
                socket.emit('showEliminationScreen', players);
            } else {
                // Volta para a tela de transição
                socket.emit('showPlayerTurn', players[currentPlayerIndex].name);
            }
        }

        function showEliminationScreen(players) {
            document.getElementById("currentTurn").style.display = "none";
            document.getElementById("shapeDeck").style.display = "none";
            document.getElementById("eliminationScreen").style.display = "flex";
            document.getElementById("gameScreen").style.display = "flex";

            // Preenche a lista de jogadores para eliminação
            const playerSelect = document.getElementById("playerSelect");
            playerSelect.innerHTML = "";
            players.forEach((player, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.textContent = player.name;
                playerSelect.appendChild(option);
            });
        }

        function eliminatePlayer() {
            const playerSelect = document.getElementById("playerSelect");
            const selectedIndex = playerSelect.value;

            // Remove o jogador selecionado da lista
            var eliminated = players.splice(selectedIndex, 1);

            // Verifica se o jogador eliminado é o impostor
            if (eliminated[0].impostor || players.length <= 2) {
                socket.emit('impostorEliminated');
            } else {
                socket.emit('playerEliminated');
            }

            // Reinicia o índice do jogador atual se necessário
            if (currentPlayerIndex >= players.length) {
                currentPlayerIndex = 0;
            }
        }

        function playerEliminated() {
            // Volta para a tela de transição
            document.getElementById("eliminationScreen").style.display = "none";
            document.getElementById("transitionScreen").style.display = "flex";
            document.getElementById("gameScreen").style.display = "flex";
            document.getElementById("playerTurnMessage").textContent = "Jogador eliminado!";
        }

        function impostorEliminated() {
            // Mostra a tela especial para o impostor eliminado
            document.getElementById("eliminationScreen").style.display = "none";
            document.getElementById("impostorEliminatedScreen").style.display = "flex";
            document.getElementById("gameScreen").style.display = "flex";
        }

        function skipElimination() {
            // Volta para a tela de transição
            document.getElementById("eliminationScreen").style.display = "none";
            document.getElementById("transitionScreen").style.display = "flex";
            document.getElementById("gameScreen").style.display = "flex";
            document.getElementById("playerTurnMessage").textContent = "É a vez do jogador " + players[currentPlayerIndex].name;
        }

        function showResults() {
            // Preenche a tabela com os resultados
            const resultsTableBody = document.getElementById("resultsTableBody");
            resultsTableBody.innerHTML = "";
            originalPlayers.forEach(player => {
                const row = document.createElement("tr");
                const playerNameCell = document.createElement("td");
                playerNameCell.textContent = player.name;
                row.appendChild(playerNameCell);
                // const colorCell = document.createElement("td");
                // colorCell.textContent = player.color;
                // row.appendChild(colorCell);
                const wordCell = document.createElement("td");
                wordCell.textContent = player.word;
                row.appendChild(wordCell);
                const impostorCell = document.createElement("td");
                impostorCell.textContent = player.impostor ? "Sim" : "Não";
                row.appendChild(impostorCell);
                resultsTableBody.appendChild(row);
            });

            // Mostra a tela de resultados
            document.getElementById("impostorEliminatedScreen").style.display = "none";
            document.getElementById("resultsScreen").style.display = "flex";
        }
    </script>
</body>

</html>
